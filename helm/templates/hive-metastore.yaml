apiVersion: v1
kind: Service
metadata:
  name: hive-metastore
  namespace: data-platform
spec:
  publishNotReadyAddresses: true
  ports:
    - name: thrift
      port: 9083
      targetPort: 9083
  selector:
    app: hive-metastore
    
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hive-metastore
  namespace: data-platform
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hive-metastore
  template:
    metadata:
      labels:
        app: hive-metastore
    spec:
      initContainers:
        # --- Wait for PostgreSQL ---
        - name: wait-for-postgres
          image: busybox:1.36
          command: ["sh", "-c"]
          args:
            - |
              echo "Waiting for PostgreSQL..."
              until nc -z postgres-hive 5432; do
                echo "Postgres not ready, retrying..."
                sleep 2
              done
              echo "Postgres ready!"

        # --- Download required JARs ---
        - name: download-jars
          image: curlimages/curl:8.4.0
          command: ["sh", "-c"]
          args:
            - |
              echo "Downloading Hadoop AWS + AWS SDK + Postgres JDBC..."
              mkdir -p /custom-lib
              curl -L -o /custom-lib/hadoop-aws-3.1.2.jar https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-aws/3.1.2/hadoop-aws-3.1.2.jar
              curl -L -o /custom-lib/aws-java-sdk-bundle-1.11.375.jar https://repo1.maven.org/maven2/com/amazonaws/aws-java-sdk-bundle/1.11.375/aws-java-sdk-bundle-1.11.375.jar
              curl -L -o /custom-lib/postgresql-42.3.3.jar https://repo1.maven.org/maven2/org/postgresql/postgresql/42.3.3/postgresql-42.3.3.jar
              echo "Jars downloaded."
          volumeMounts:
            - name: hive-lib
              mountPath: /custom-lib

      containers:
        - name: metastore
          image: apache/hive:3.1.3
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Copying extra JARs to Hive auxlib..."
              mkdir -p /opt/hive/auxlib
              cp /custom-lib/*.jar /opt/hive/auxlib/

              echo "Initializing Hive Metastore schema (if needed)..."
              /opt/hive/bin/schematool -dbType postgres -initSchema --verbose || true

              echo "Starting Hive Metastore on port 9083..."
              /opt/hive/bin/hive --service metastore -p 9083

          env:
            - name: HIVE_CONF_DIR
              value: /opt/hive/conf
            - name: HADOOP_CONF_DIR
              value: /opt/hadoop/etc/hadoop
            - name: HADOOP_CLIENT_OPTS
              value: "-Xmx1G"

          ports:
            - containerPort: 9083

          volumeMounts:
            - name: hive-config-vol
              mountPath: /opt/hive/conf/hive-site.xml
              subPath: hive-site.xml
            - name: hadoop-conf
              mountPath: /opt/hadoop/etc/hadoop/core-site.xml
              subPath: core-site.xml
            - name: hive-lib
              mountPath: /custom-lib

      volumes:
        - name: hive-config-vol
          configMap:
            name: hive-config

        - name: hadoop-conf
          configMap:
            name: flink-hadoop-conf

        - name: hive-lib
          emptyDir: {}
