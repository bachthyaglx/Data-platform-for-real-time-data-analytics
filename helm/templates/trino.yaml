{{- if .Values.trino.enabled }}

# =========================
# Trino Config (config.properties, jvm.config, node.properties)
# =========================
apiVersion: v1
kind: ConfigMap
metadata:
  name: trino-config
  namespace: {{ include "data-platform.namespace" . }}
data:
  config.properties: |
    coordinator=true
    node-scheduler.include-coordinator=true
    http-server.http.port=8080
    discovery-server.enabled=true
    discovery.uri=http://trino:8080
    catalog.config-dir=/etc/trino/catalog

  jvm.config: |
    -Xmx1G
    -XX:+UseG1GC
    -XX:G1HeapRegionSize=32M
    -XX:+UseGCOverheadLimit
    -XX:+ExplicitGCInvokesConcurrent
    -XX:+HeapDumpOnOutOfMemoryError
    -XX:-OmitStackTraceInFastThrow
    -XX:+UnlockDiagnosticVMOptions
    -XX:G1NumCollectionsKeepPinned=10000000

  node.properties: |
    node.environment=production
    node.id=trino-1
    node.data-dir=/data/trino

---
# =========================
# Trino Catalogs: Hive + Iceberg
# =========================
apiVersion: v1
kind: ConfigMap
metadata:
  name: trino-catalogs
  namespace: {{ include "data-platform.namespace" . }}
data:
  hive.properties: |
    connector.name=hive
    hive.metastore.uri=thrift://hive-metastore:9083
    hive.non-managed-table-writes-enabled=true
    hive.non-managed-table-creates-enabled=true
    hive.s3.endpoint=http://minio.{{ include "data-platform.namespace" . }}.svc.cluster.local:9000
    hive.s3.path-style-access=true
    hive.s3.region=us-east-1
    hive.s3.aws-access-key={{ .Values.minio.accessKey }}
    hive.s3.aws-secret-key={{ .Values.minio.secretKey }}

  iceberg.properties: |
    connector.name=iceberg
    iceberg.catalog.type=hive_metastore
    fs.native-s3.enabled=false
    hive.metastore.uri=thrift://hive-metastore:9083
    hive.s3.endpoint=http://minio.data-platform.svc.cluster.local:9000
    hive.s3.path-style-access=true
    hive.s3.ssl.enabled=false
    hive.s3.region=us-east-1
    hive.s3.aws-access-key={{ .Values.minio.accessKey }}
    hive.s3.aws-secret-key={{ .Values.minio.secretKey }}

---
# =========================
# Trino Service (NodePort)
# =========================
apiVersion: v1
kind: Service
metadata:
  name: trino
  namespace: {{ include "data-platform.namespace" . }}
spec:
  type: NodePort
  selector:
    app: trino
  ports:
    - name: http
      port: 8080       
      targetPort: 8080   
      nodePort: {{ .Values.trino.nodePort }}

---
# =========================
# Trino Deployment (single-node: coordinator + worker)
# =========================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: trino
  namespace: {{ include "data-platform.namespace" . }}
spec:
  replicas: {{ .Values.trino.replicas }}
  selector:
    matchLabels:
      app: trino
  template:
    metadata:
      labels:
        app: trino
    spec:
      containers:
        - name: trino
          image: "{{ .Values.trino.image.repository }}:{{ .Values.trino.image.tag }}"

          imagePullPolicy: {{ .Values.trino.image.pullPolicy }}
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: trino-config
              mountPath: /etc/trino/config.properties
              subPath: config.properties
            - name: trino-config
              mountPath: /etc/trino/jvm.config
              subPath: jvm.config
            - name: trino-config
              mountPath: /etc/trino/node.properties
              subPath: node.properties
            - name: trino-catalogs
              mountPath: /etc/trino/catalog
          env:
            - name: JAVA_TOOL_OPTIONS
              value: "-Duser.timezone=UTC"
      volumes:
        - name: trino-config
          configMap:
            name: trino-config
        - name: trino-catalogs
          configMap:
            name: trino-catalogs

{{- end }}
